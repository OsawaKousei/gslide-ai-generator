name: Initialize Repository

# リポジトリへのプッシュ時に発火
on:
  push:
    branches:
      - main

jobs:
  initialize:
    # テンプレートリポジトリ自体では実行しないガード条件
    if: github.repository != 'OsawaKousei/ViteCSRAppTemplate'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 初回のコミット（テンプレートからの生成直後）であるかを判定
      - name: Check if initialization is needed
        id: check_init
        run: |
          commit_count=$(git rev-list --count HEAD)
          if [ "$commit_count" -le 2 ]; then
            echo "run_init=true" >> $GITHUB_OUTPUT
          else
            echo "run_init=false" >> $GITHUB_OUTPUT
          fi

      # package.json の name と author を書き換え
      - name: Update app/package.json
        if: steps.check_init.outputs.run_init == 'true'
        run: |
          # jqを使って安全にJSONを書き換える
          # name: リポジトリ名 (小文字化)
          # author: GitHubのアクター名 (リポジトリ作成者)
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

          # appディレクトリ内のpackage.jsonを対象にする
          cd app
          jq --arg name "$REPO_NAME" --arg author "${{ github.actor }}" \
            '.name = $name | .author = $author' package.json > package.json.tmp && mv package.json.tmp package.json
            
          echo "Updated app/package.json name to $REPO_NAME"

      # docker-compose.yaml の volume名とサービス名を書き換え
      - name: Update docker-compose.yaml
        if: steps.check_init.outputs.run_init == 'true'
        run: |
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

          # サービス名の変更 (  app: ->   repo-name:)
          # インデント2つの app: を置換
          sed -i "s/^  app:/  ${REPO_NAME}:/" docker-compose.yaml

          # ボリューム名の変更 (app-node-modules -> repo-name-node-modules)
          sed -i "s/app-node-modules/${REPO_NAME}-node-modules/g" docker-compose.yaml

          echo "Updated docker-compose.yaml service and volume names"

      # package-lock.json がある場合は削除 (名前変更後の整合性のため)
      - name: Cleanup package-lock.json
        if: steps.check_init.outputs.run_init == 'true'
        run: |
          if [ -f "app/package-lock.json" ]; then
            rm app/package-lock.json
          fi

      # このワークフローファイル自身を削除
      - name: Remove initialization workflow
        if: steps.check_init.outputs.run_init == 'true'
        run: |
          git rm .github/workflows/init.yaml

      # 変更をまとめてコミット＆プッシュ
      - name: Commit and push changes
        if: steps.check_init.outputs.run_init == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: initialize repository (update name & author)"
          branch: main
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
